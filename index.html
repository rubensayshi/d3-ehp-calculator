<!DOCTYPE html>
<html lang="en">
<head>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
    <script src="http://ajax.cdnjs.com/ajax/libs/json2/20110223/json2.js"></script>
    <script src="http://ajax.cdnjs.com/ajax/libs/underscore.js/1.3.3/underscore-min.js"></script>
    <script src="http://ajax.cdnjs.com/ajax/libs/backbone.js/0.9.2/backbone-min.js"></script>
    
    <script src="http://twitter.github.com/bootstrap/assets/js/bootstrap-transition.js"></script>
    <script src="http://twitter.github.com/bootstrap/assets/js/bootstrap-alert.js"></script>
    <script src="http://twitter.github.com/bootstrap/assets/js/bootstrap-dropdown.js"></script>
    <script src="http://twitter.github.com/bootstrap/assets/js/bootstrap-tab.js"></script>
    <script src="http://twitter.github.com/bootstrap/assets/js/bootstrap-button.js"></script>
    
    <link href="http://twitter.github.com/bootstrap/assets/css/bootstrap.css" rel="stylesheet" />
    <style>
         .templates {
            display: none;
         }
         
         .highlighted-row {
            background-color: #f9f9f9;
         }
         
         .highlighted-row th, .highlighted-row td {
            border-top: 1px solid black;
            border-bottom: 2px solid black;
         }
         table {
            width: 780px;
         }
         thead th {
            border-bottom: 1px solid black;
         }
         
    </style>
</head>
<div class="container">
    <div class="row">
      <div id="ehp" class="offset1 span10"></div>
    </div>
</div>

<div class="templates">
    <div id="simulation-template">
        <table id="options" class="table table-bordered">
            <thead>
                <tr>
	                <th width="35%">Option</th>
	                <th>Choice</th>
	                <th width="30%">&nbsp;</th>
                </tr>
            </thead>
            <tbody>
              <tr>
                <th>Your Class</th>
                <td>
                  <select class="your_class">
                    <option value="br">Barbarian</option>
                    <option value="dh">Demon Hunter</option>
                    <option value="mn">Monk</option>
                    <option value="wd">Witch Doctor</option>
                    <option value="wz">Wizard</option>
                  </select>
                </td>
                <td></td>
              </tr>
	            <tr>
		            <th>Your level</th>
		            <td><input type="text" class="level" value="" /></td>
		            <td></td>
	             </tr>
                <tr>
		            <th>Mob level</th>
		            <td><input type="text" class="moblevel" value="" /></td>
                    <td></td>
	            </tr>
                <tr>
		            <th>VIT</th>
		            <td><input type="text" class="base_vit" value="" /></td>
                    <td></td>
	            </tr>
                <tr>
		            <th>+ Life %</th>
		            <td><input type="text" class="extra_life" value="" /></td>
                    <td></td>
	            </tr>
                <tr>
		            <th>Armor</th>
		            <td><input type="text" class="base_armor" value="" />  <br /></td>
                    <td></td>
	            </tr>
                <tr>
		            <th>Resistance</th>
		            <td><input type="text" class="base_resist" value="" /></td>
                    <td></td>
	            </tr>
           </table>
           <table id="results" class="table table-bordered">
             <thead>
                <tr>
	                <th width="35%">Results</th>
	                <th>&nbsp;</th>
	                <th width="30%">&nbsp;</th>
                </tr>
             </thead>
             <tbody>
                <tr class="highlighted-row">
		            <th>Buffed Life</th>
		            <td><input type="text" readonly=true class="life" value="" /></td>
                    <td></td>
	            </tr>
                <tr class="highlighted-row">
		            <th>Buffed Armor</th>
		            <td><input type="text" readonly=true class="armor" value="" /></td>
                    <td class="armor_reduc"></td>
	            </tr>
                <tr class="highlighted-row">
		            <th>Buffed Resistance</th>
		            <td><input type="text" readonly=true class="resist" value="" /></td>
                    <td class="resist_reduc"></td>
	            </tr>
            </tbody>
            <tfoot>
                <tr class="highlighted-row">
                    <th>EHP melee</th>
                    <td><input type="text" readonly=true class="ehp_melee" value="" /></td>
                    <td></td>
                </tr>
                <tr class="highlighted-row">
                    <th>EHP</th>
                    <td><input type="text" readonly=true class="ehp" value="" /></td>
                    <td></td>
                </tr>
                <tr>
                    <th></th>
                    <td></td>
                    <td><button class="reset btn btn-primary">refresh</button></td>
                </tr>
            </tfoot>
        </table>
    </div>
    <div id="simulation-br-template">
        <table class="table table-bordered class_options">
            <thead>
                <tr>
	                <th width="35%">Barbarian Options</th>
	                <th>&nbsp;</th>
	                <th width="30%">Alternative</th>
                </tr>
            </thead>
            <tr>
              <th>War Cry - Invigorate</th>
              <td><input type="checkbox" class="warcry_life" value="1" /></td>
                  <td class="warcry_life_alt_ehp"></td>
            </tr>
            
              <tr>
              <th>Tough As Nails</th>
              <td><input type="checkbox" class="toughasnails" value="1" /></td>
                  <td class="toughasnails_alt_ehp"></td>
            </tr>
              <tr>
              <th>Nerves Of Steel</th>
              <td><input type="checkbox" class="vittoarmor" value="1" /></td>
                  <td class="vittoarmor_alt_ehp"></td>
            </tr>
              <tr>
              <th>War Cry - No Rune</th>
              <td><input type="checkbox" class="warcry" value="1" /></td>
                  <td class="warcry_alt_ehp"></td>
            </tr>
              <tr>
              <th>War Cry - Hardened Wrath</th>
              <td><input type="checkbox" class="warcry_armor" value="1" /></td>
                  <td class="warcry_armor_alt_ehp"></td>
            </tr>
             
              <tr>
              <th>WarCry - Impunity</th>
              <td><input type="checkbox" class="warcry_resist" value="1" /></td>
                  <td class="warcry_resist_alt_ehp"></td>
            </tr>
            
              <tr>
              <th>Threatening Shout (you can't get it on ranged)</th>
              <td><input type="checkbox" class="threat_shout" value="1" /></td>
                  <td class="threat_shout_alt_ehp"></td>
            </tr>
              <tr>
              <th>Superstition (won't work on physical)</th>
              <td><input type="checkbox" class="superstition" value="1" /></td>
                  <td class="superstition_alt_ehp"></td>
            </tr>
        </table>
    </div>
    
    <div id="simulation-wz-template">
        <table class="table table-bordered class_options">
            <thead>
                <tr>
	                <th width="35%">Wizard Options</th>
	                <th>&nbsp;</th>
	                <th width="30%">Alternative</th>
                </tr>
            </thead> 
            <tr>
              <th>Blur</th>
              <td><input type="checkbox" class="blur" value="1" /></td>
                  <td class="blur_alt_ehp melee_only"></td>
            </tr>
            <tr>
              <th>Energy Armor</th>
              <td><input type="checkbox" class="energy_armor" value="1" /></td>
                  <td class="energy_armor_alt_ehp"></td>
            </tr>
            <tr>
              <th>Energy Armor - Prismatic</th>
              <td><input type="checkbox" class="prismatic" value="1" /></td>
                  <td class="prismatic_alt_ehp"></td>
            </tr>
            <tr>
              <th>Glass Cannon</th>
              <td><input type="checkbox" class="glass_cannon" value="1" /></td>
                  <td class="glass_cannon_alt_ehp"></td>
            </tr>
            
        </table>
    </div>
    
    <div id="simulation-not-available-template">
        <table class="table table-bordered class_options">
            <thead>
                <tr>
	                <th width="35%">Class Options Not Supported</th>
	                <th>&nbsp;</th>
	                <th width="30%">&nbsp;</th>
                </tr>
            </thead>
        </table>
    </div>
</div>

<script>
(function($) {
	var VERSION = "32c4fee62e6fe2b7efc9898f7344a1cd9f09aa21";
	
    var Character = Backbone.Model.extend({
        defaults : {
            level:        60,
            base_vit:     1200,
            base_armor:   4000,
            base_resist:  300,
            extra_life:   12,
            classes:      {
                "br": { melee: true },
                "dh": { melee: false },
                "mn": { melee: true },
                "wd": { melee: false },
                "wz": { melee: false }
            },
            
            moblevel:     63,

            vit:          null,
            life:         null,
            armor:        null,
            resist:       null,
            armor_reduc:  null,
            resist_reduc: null,
        },
      
        initialize : function () {
        	if (this.get('options')) {
	            _.each(this.get('options'), function(o_default, o_name) {
	                if( typeof(this.get(o_name)) == undefined ) this.set(o_name, o_default);
	            }, this);   
            }
            this.on('change', this.simulate);
            
            this.simulate();
        },
        
        getAllInputStats : function () {
        	return _.extend({}, {
                your_class:   this.get('your_class'),
                level:        this.get('level'),
                base_vit:     this.get('base_vit'),
                base_armor:   this.get('base_armor'),
                base_resist:  this.get('base_resist'),
                extra_life:   this.get('extra_life'),
                moblevel:     this.get('moblevel'),
        	}, this.get('options'));
        },
        
        /*
         * these modify methods should be implemented by specific class classes
         *  the modifyBase* methods will modify the base stat before the modifier is applied
         *  the modify*Modifier methods will modify the modifier (most of the time that starts on 1) and is applied to the base afterwards
         * 
         * note that if you implement modifyReductionModifier you'll either have to call super or copy the contents of the method here
         */
        modifyBaseArmor              : function (armor)          { return armor; },
        modifyArmorModifier          : function (armormodifier)  { return armormodifier; },
        modifyBaseResist             : function (resist)         { return resist; },
        modifyResistModifier         : function (resistmodifier) { return resistmodifier; },
        modifyBaseLife               : function (life)           { return life; },
        modifyLifeModifier           : function (lifemodifier)   { return lifemodifier; },
        modifyReductionModifier      : function (modifier)       {
            if (this.get('melee')) {
                modifier *= (1 - 0.30);
            }
            
            return modifier;
        },
        modifyReductionModifierMelee : function (modifier)       { return modifier; },
      
        simulate : function () { 
            this.set('armor',  this.get('base_armor'));
            this.set('resist', this.get('base_resist'));
            this.set('vit',    this.get('base_vit'));

            this.set('armor',  this.modifyBaseArmor(this.get('armor')));
            this.set('resist', this.modifyBaseResist(this.get('resist')));

            armormodifier = 1; 
            armormodifier = this.modifyArmorModifier(armormodifier);
            
            resistmodifier = 1; 
            resistmodifier = this.modifyResistModifier(resistmodifier);

            this.set('armor',  this.get('armor')  * armormodifier);
            this.set('resist', this.get('resist') * resistmodifier);
            
            this.set('armor_reduc',  this.get('armor') /  (50 * this.get('moblevel') + this.get('armor')));
            this.set('resist_reduc', this.get('resist') / (5  * this.get('moblevel') + this.get('resist')));
            
            var modifier = 1;
            modifier *= (1 - this.get('armor_reduc'));
            modifier *= (1 - this.get('resist_reduc'));
            
            modifier = this.modifyReductionModifier(modifier);
            
            var modifier_melee = this.modifyReductionModifierMelee(modifier);
            
            if (this.get('level') < 35) {
                this.set('life', (36 + (4 * this.get('level')) + (10 * this.get('vit'))));
            } else {
                this.set('life', (60 - 25) * this.get('vit'));
            }

            this.set('life', this.modifyBaseLife(this.get('life')));
            
            var lifemodifier = 1 + (this.get('extra_life') / 100);
            
            lifemodifier = this.modifyLifeModifier(lifemodifier);
                        
            this.set('life', this.get('life') * lifemodifier);
            
            var ehp = this.get('life') / modifier;
            var ehp_melee = this.get('life') / modifier_melee;
            
            this.set('ehp', ehp);
            this.set('ehp_melee', ehp_melee);
        }
    });
    var Barbarian = Character.extend({
        defaults: _.extend({}, Character.prototype.defaults, {
            your_class: "br",
            melee     : true,
            options   : {
                toughasnails: false,
                vittoarmor:   false,
                warcry:       false,
                warcry_armor: false,
                warcry_resist:false,
                threat_shout: false,
                superstition: false,
            },
        }),
        
        modifyBaseArmor : function (armor) {
            if (this.get('vittoarmor')) {
                armor += this.get('vit');
            }
            
            return armor
        },
        
        modifyArmorModifier : function (armormodifier) {
        	// any version of warcry gives 20%
	        if (this.get('warcry') || this.get('warcry_armor') || this.get('warcry_resist') || this.get('warcry_life')) {
	            armormodifier += .2;
	        }
	        // warcry runed for armor gives an aditional 20%
	        if (this.get('warcry_armor')) {
	            armormodifier += .2;
	        }
	        
            if (this.get('toughasnails')) {
            	armormodifier += .25;
            }
            
            return armormodifier;
        },
        
        modifyResistModifier : function (resistmodifier) {
            if (this.get('warcry_resist')) {
            	resistmodifier += .50;
            }
            
            return resistmodifier;
        },

        modifyLifeModifier : function (lifemodifier) {
            if (this.get('warcry_life')) {
                lifemodifier += 0.10;
            }
            
            return lifemodifier; 
        },
        
        modifyReductionModifier : function (modifier) {
            if (this.get('threat_shout')) {
                modifier *= (1 - 0.25);
            }
            
            if (this.get('superstition')) {
                modifier *= (1 - 0.20);
            }
            
            if (this.get('melee')) {
                modifier *= (1 - 0.30);
            }
            
            return modifier;
        }
    });
    var Wizard = Character.extend({
        defaults: _.extend({}, Character.prototype.defaults, {
            your_class: "wz",
            melee     : false,
            options   : {
                energy_armor:            false,
                prismatic:  false,
                blur:                    false,
                glass_cannon:            false,
            },
        }),
        
        modifyArmorModifier : function (armormodifier) {
            if (this.get('energy_armor')) {
            	armormodifier += .65;
            }
            
            if (this.get('glass_cannon')) {
            	armormodifier -= .10;
            }
            
            return armormodifier;
        },
        
        modifyResistModifier : function (resistmodifier) {
            if (this.get('prismatic')) {
            	resistmodifier += .40;
            }
            
            if (this.get('glass_cannon')) {
            	resistmodifier -= .10;
            }
            
            return resistmodifier;
        },
        
        modifyReductionModifierMelee : function (modifier) {
            if (this.get('blur')) {
                modifier *= (1 - 0.20);
            }
            
            return modifier;
        }
    });
        
    var SimulationView = Backbone.View.extend({
        el: $('#ehp'),
        
        events: {
            'change input':       'viewToModel',
            'change .your_class': 'changeClass',
            'click button.reset': 'viewToModel'
        },
        
        fieldMap: {
            '.your_class':      'your_class',
            '.level':           'level',
            '.extra_life':      'extra_life',
            '.base_vit':        'base_vit',
            '.base_armor':      'base_armor',
            '.base_resist':     'base_resist',
            
            // BARBARIAN
            '.toughasnails':    'toughasnails',
            '.vittoarmor':      'vittoarmor',
            '.warcry':          'warcry',
            '.warcry_armor':    'warcry_armor',
            '.warcry_resist':   'warcry_resist',
            '.warcry_life':     'warcry_life',
            '.threat_shout':    'threat_shout',
            '.superstition':    'superstition',
            
            // WIZARD
            '.energy_armor':    'energy_armor',
            '.prismatic':       'prismatic',
            '.blur':            'blur',
            '.glass_cannon':    'glass_cannon',
            
            '.moblevel':        'moblevel',

            '.life':            'life',
            '.armor':           'armor',
            '.resist':          'resist',
            '.armor_reduc':     'armor_reduc',
            '.resist_reduc':    'resist_reduc',  
            
            '.ehp_melee':       'ehp_melee',
            '.ehp':             'ehp'
        },
        
        classFields: [
            'toughasnails',
            'vittoarmor',
            'warcry',
            'warcry_armor',
            'warcry_resist',
            'warcry_life',
            'threat_shout',
            'superstition',
            'energy_armor',
            'prismatic',
            'blur',
            'glass_cannon'
        ],
        
        initialize: function() {        	
            _.bindAll(this, 'render', 'modelToView', 'viewToModel', 'changeClass');

            this.template = _.template($('#simulation-template').html());
            
            this.class_templates = {
                "br": _.template($('#simulation-br-template').html()),
                "dh": _.template($('#simulation-not-available-template').html()),
                "mn": _.template($('#simulation-not-available-template').html()),
                "wd": _.template($('#simulation-not-available-template').html()),
                "wz": _.template($('#simulation-wz-template').html())
            };
            
            this.render();
            this.changeClass();
        },
        
        viewToModel: function() {
            _.each(this.fieldMap, function(field, selector) {   
                var $fieldObj = $(selector,  this.el);
                
                if ($fieldObj.is('span')) {
                    // -- 
                } else if ($fieldObj.is('input') && $fieldObj.prop('type') == 'checkbox') {
                    this.model.set(field, !!$fieldObj.prop('checked'), {silent: true});
                } else if ($fieldObj.is('input') && $fieldObj.prop('type') == 'text' && !$fieldObj.prop('readonly')) {
                    this.model.set(field, parseInt($fieldObj.val()), {silent: true});
                } else if ($fieldObj.is('select') && !$fieldObj.prop('readonly')) {
                    this.model.set(field, $fieldObj.val(), {silent: true});
                }
            }, this);
            
            _.each(this.fieldMap, function(field, selector) {
                this.model.change(field);
            }, this);
        },
        
        modelToView: function() {
            $(this.el).find('.class_options').remove();
            $(this.el).find('#options').after($(this.class_templates[this.model.get('your_class')]()));
            
            _.each(this.fieldMap, function(field, selector) {
                var $fieldObj = $(selector,  this.el);
                
                if ($fieldObj.is('span')) {
                    $fieldObj.html(this.prepareVal(this.model.get(field)));
                } else if ($fieldObj.is('input') && $fieldObj.prop('type') == 'checkbox') {
                    $fieldObj.prop('checked', !!this.model.get(field));
                } else if ($fieldObj.is('input') && $fieldObj.prop('type') == 'text') {
                    $fieldObj.val(this.prepareVal(this.model.get(field)));
                } else if ($fieldObj.is('select')) {
                    $fieldObj.val(this.model.get(field));
                }
            }, this);
            
            var ehp = this.model.get('ehp');
            var ehp_melee = this.model.get('ehp_melee');
            
            var alt_booleans = this.classFields;
            
            _.each(alt_booleans, function(alt_field) {
                var selector  = "." + alt_field +  "_alt_ehp";
                var alt_val   = !this.model.get(alt_field);
                var alt_model = this.model.clone();
                
                alt_model.set(alt_field, alt_val);
                if($(selector, this.el).hasClass('melee_only')){
                    $(selector, this.el).html(this.prepareVal(alt_model.get('ehp_melee')) + " EHP melee; " + this.alternativePercentage(alt_model.get('ehp_melee'), ehp_melee, alt_val) + "% change");
                } else {
                    $(selector, this.el).html(this.prepareVal(alt_model.get('ehp')) + " EHP; " + this.alternativePercentage(alt_model.get('ehp'), ehp, alt_val) + "% change");
                }
            }, this);
        },
        
        changeClass: function(event) {        	
            classname = $('.your_class', this.el).val();
            
            this.model = getModelForClass(classname);
            this.model.on('change', this.modelToView, this);

            this.modelToView();
        },
        
        alternativePercentage: function(alt_ehp, ehp, toughasnails_alt) {
            var val1 = ehp;
            var val2 = alt_ehp;
            
            var relativeto = toughasnails_alt ? val1 : val2;
            
            return this.prepareVal(((val2 - val1) / relativeto) * 100);
        },
        
        prepareVal: function(val) {
            return this.roundNumber(val, 3);
        },
        
        roundNumber: function(num, dec) {
            return Math.round(num*Math.pow(10,dec))/Math.pow(10,dec);
        },
        
        render: function() {
            $(this.template()).appendTo($(this.el));
        },
    });
    
    var getModelForClass = function(classname, forceNew) {
    	storage_key = 'previous_' + VERSION + '_' + classname;
        if (classname == 'br')      modelclass = Barbarian;
        else if (classname == 'wz') modelclass = Wizard;
        else                        console.log(classname);
    	
        if (!forceNew && localStorage && localStorage.getItem(storage_key)) {
            model = new modelclass(JSON.parse(localStorage.getItem(storage_key)));
        } else {
            model = new modelclass();
        }
        
        if (localStorage) {
            model.on('change', function(model) {
                localStorage.setItem(storage_key, JSON.stringify(model));
            }, model);
        }
        
        return model;
    }
    
    var simView = new SimulationView({'model': getModelForClass('br')});
})(jQuery);
</script>

<script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-32071149-1']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();

</script>
</html>
